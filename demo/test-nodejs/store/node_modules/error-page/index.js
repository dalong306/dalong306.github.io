/*
 * 错误页面统一处理
 * 缓存依赖于cache模块
 * */
module.exports = function (app, res, errMsg) {

	var f = require('node-fetch-url');
	var cache = require('cache');
	var errorPageUrl = app.get('snDomain') + '/404.html';
	var logger = app.get('logger');

	var errPageHtml = cache.get('errPageHtml');
	if (errPageHtml) {
		res.send(404, errPageHtml);
		res.end();
		logger.error(errMsg);
	} else {
		f.request({
			url: errorPageUrl
		}, function (error, data) {
			if (error && !/timeout/i.test(error)) {
				if (res) {
					res.send(404, errPageHtml);
					res.end();
				}
				logger.error(error);
			}
			errPageHtml = data.body;
			cache.set('errPageHtml', errPageHtml, 3600 * 24);
			res.send(404, errPageHtml);
			logger.error(errMsg);
		});
	}
}